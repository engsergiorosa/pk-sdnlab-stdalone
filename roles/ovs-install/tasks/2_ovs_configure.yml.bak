---

# creating ovs bridges

- name: Create bridges at ovs
  openvswitch_bridge:
    bridge: "{{ item }}"
    state: present
  with_items:
    - br-wan
    - br-dc
    - external

- name: enable STP at bridges
  shell: "ovs-vsctl set bridge {{ item }} stp_enable=true"
  with_items: 
    - br-wan
    - br-dc

# Creating ovs vxlan ports
- name: checking vxlan ports at br-wan
  shell: ovs-vsctl show | grep bw-vxlan
  register: bw_vxlan
  ignore_errors: yes

- name: checking vxlan ports at dc-wan
  shell: ovs-vsctl show | grep dc-vxlan
  register: dc_vxlan
  ignore_errors: yes

- name: creating vxlan connectivity for br-wan
  shell: ovs-vsctl add-port br-wan bw-vxlan{{ item.0 }} -- set Interface bw-vxlan{{ item.0 }} type=vxlan options:remote_ip={{ item.1 }} options:key=10
  when: 
    - item.1 != private_ip
    - bw_vxlan.stdout == ""
  with_indexed_items: "{{ private_ip_list }}"

- name: creating vxlan connectivity for br-dc 
  shell: ovs-vsctl add-port br-dc dc-vxlan{{ item.0 }} -- set Interface dc-vxlan{{ item.0 }} type=vxlan options:remote_ip={{ item.1 }} options:key=20
  when: 
    - item.1 != private_ip
    - dc_vxlan.stdout == ""
  with_indexed_items: "{{ private_ip_list }}"

